# HK Insurance AML 查詢系統 - 系統架構文檔

## 📋 系統概述

本系統是一個基於 Flask 的 AML (反洗錢) 查詢系統，結合會員制度管理，提供三層會員權限的犯罪資料查詢服務。

### 🎯 核心功能
- AML 犯罪資料查詢 (14,528 筆記錄)
- 三層會員制度 (管理員/付費會員/基本會員)
- Email 驗證註冊流程
- 查詢次數限制管理
- 管理員後台管理

---

## 🗂️ 檔案結構

```
/home/weschen/HK_insurance/
├── hk-ia-function/
│   ├── main_full.py                    # 主要 Flask 應用程式
│   ├── setup_members.py                # 會員資料庫初始化腳本
│   ├── requirements.txt                # Python 依賴套件
│   ├── venv/                          # Python 虛擬環境
│   └── templates/
│       ├── base.html                  # 基礎模板
│       ├── login_fixed.html           # 登入頁面
│       ├── register_fixed.html        # 註冊頁面
│       ├── admin_dashboard.html       # 管理員儀表板
│       ├── member_dashboard.html      # 會員儀表板
│       ├── query_result.html          # 查詢結果頁面
│       └── ...
├── aml_profiles.db                    # AML 犯罪資料庫 (14,528 筆記錄)
├── members.db                         # 會員系統資料庫
└── downloads/                         # PDF 文檔資料
```

---

## 🔧 技術架構

### 後端框架
- **Flask 3.1.2** - Web 應用框架
- **SQLite** - 資料庫引擎
- **bcrypt** - 密碼加密
- **secrets** - 安全隨機數生成

### 前端技術
- **Bootstrap 5** - UI 框架
- **Font Awesome** - 圖標庫
- **jQuery** - JavaScript 庫

### 開發環境
- **Python 3.x** - 程式語言
- **Virtual Environment** - 環境隔離

---


### 2. 會員資料庫 (members.db)
```sql
-- 用戶表
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    role TEXT DEFAULT 'basic',
    query_limit INTEGER DEFAULT 5,
    queries_used INTEGER DEFAULT 0,
    is_verified INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP
);

-- 查詢記錄表
CREATE TABLE query_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    query_term TEXT,
    result_count INTEGER,
    query_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id)
);

-- 密碼重設表
CREATE TABLE password_resets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    token TEXT UNIQUE,
    expires_at TIMESTAMP,
    used INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id)
);

-- Email 驗證表
CREATE TABLE email_verifications (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    verification_code TEXT,
    expires_at TIMESTAMP,
    verified INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id)
);

-- 付費記錄表
CREATE TABLE payment_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    amount DECIMAL(10,2),
    currency TEXT DEFAULT 'HKD',
    payment_method TEXT,
    transaction_id TEXT,
    status TEXT DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id)
);
```

---

## 🔐 會員權限系統

### 會員等級
| 等級 | 查詢限制 | 功能權限 |
|------|----------|----------|
| **基本會員 (basic)** | 5 次 (總計) | 基本查詢功能 |
| **付費會員 (paid)** | 無限制 | 完整查詢功能 |
| **管理員 (admin)** | 無限制 | 系統管理、用戶管理 |

### 預設管理員帳號
- **Email**: astcws@hotmail
- **密碼**: admin123

---

## 🚀 核心功能模組

### 1. 用戶認證模組 (`main_full.py` 第 100-200 行)
```python
# 註冊功能
@app.route('/register', methods=['GET', 'POST'])
def register():
    # 用戶註冊邏輯
    # 密碼加密
    # Email 驗證碼生成
    pass

# 登入功能  
@app.route('/login', methods=['GET', 'POST'])
def login():
    # 用戶登入驗證
    # Session 管理
    # 角色重定向
    pass

# Email 驗證
@app.route('/verify_email/<verification_code>')
def verify_email(verification_code):
    # Email 驗證邏輯
    # 帳號啟用
    pass
```

### 2. AML 查詢模組 (`main_full.py` 第 300-400 行)
```python
# AML 資料查詢
@app.route('/api/query', methods=['POST'])
def query_profiles():
    # 查詢權限檢查
    # 查詢次數扣除
    # 資料庫查詢
    # 結果返回
    pass

# 查詢記錄
def log_query(user_id, query_term, result_count):
    # 查詢記錄儲存
    pass
```

### 3. 會員管理模組 (`main_full.py` 第 500-600 行)
```python
# 管理員儀表板
@app.route('/admin_dashboard')
def admin_dashboard():
    # 用戶列表
    # 系統統計
    # 管理功能
    pass

# 用戶權限修改
@app.route('/admin/update_user/<int:user_id>', methods=['POST'])
def update_user(user_id):
    # 權限修改
    # 查詢次數設定
    pass
```

### 4. Email 服務模組 (待實作)
```python
# SendGrid Email 服務
SENDGRID_API_KEY = "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"

def send_verification_email(email, verification_code):
    # SendGrid Email 發送
    # 驗證碼模板
    pass
```

---

## 🎨 前端模板架構

### 基礎模板 (`templates/base.html`)
- Bootstrap 5 框架
- 響應式設計
- Font Awesome 圖標
- 導航列和頁尾

### 主要頁面模板
1. **登入頁面** (`templates/login_fixed.html`)
   - 用戶登入表單
   - 密碼顯示切換
   - Flash 訊息顯示

2. **註冊頁面** (`templates/register_fixed.html`)
   - 用戶註冊表單
   - 密碼強度檢查
   - 會員等級說明

3. **儀表板** (`templates/admin_dashboard.html`, `templates/member_dashboard.html`)
   - 角色專屬功能
   - 查詢介面
   - 統計資訊

---

## 🔄 系統流程

### 用戶註冊流程
1. 填寫註冊表單
2. 系統生成驗證碼
3. 發送 Email 驗證
4. 用戶點擊驗證連結
5. 帳號正式啟用

### 查詢流程
1. 用戶登入系統
2. 檢查查詢權限
3. 執行 AML 資料查詢
4. 扣除查詢次數
5. 返回查詢結果
6. 記錄查詢日誌

---

## 📋 待修改項目清單

### 1. 註冊驗證功能 ⚠️
**檔案**: `main_full.py` (第 100-150 行)
**現況**: 註冊後直接啟用帳號
**需求**: 發送 Email 驗證碼，驗證後才啟用
**修改點**:
```python
# 在這裡添加您的修改說明
```

### 2. SendGrid Email 整合 ⚠️
**檔案**: `main_full.py` (新增模組)
**現況**: 無 Email 發送功能
**需求**: 整合 SendGrid API 發送驗證 Email
**API Key**: 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
**修改點**:
```python
# 在這裡添加您的修改說明
```

### 3. 新會員查詢限制 ⚠️
**檔案**: `main_full.py` (第 120 行 - 註冊函數)
**現況**: 新會員預設 10 次查詢
**需求**: 改為 5 次總計查詢限制
**修改點**:
```python
# 在這裡添加您的修改說明
```

### 4. 管理員用戶管理功能 ⚠️
**檔案**: `main_full.py` (第 500-600 行)
**現況**: 管理員無法修改用戶權限
**需求**: 新增用戶權限和查詢次數設定功能
**修改點**:
```python
# 在這裡添加您的修改說明
```

### 5. 查詢功能簡化 ⚠️
**檔案**: `main_full.py` (第 300-400 行)
**現況**: 複雜查詢介面
**需求**: 簡化為只搜尋姓名
**修改點**:
```python
# 在這裡添加您的修改說明
```

---

## 🛠️ 開發說明

### 啟動系統
```bash
cd /home/weschen/HK_insurance/hk-ia-function
source venv/bin/activate
python main_full.py
```

### 訪問地址
- **主頁**: http://127.0.0.1:5000
- **登入**: http://127.0.0.1:5000/login
- **註冊**: http://127.0.0.1:5000/register
- **管理員**: http://127.0.0.1:5000/admin_dashboard

### 測試帳號
- **管理員**: astcws@hotmail / admin123

---

## 📝 注意事項

1. **安全性**: 所有密碼使用 bcrypt 加密儲存
2. **會話管理**: 使用 Flask Session 管理用戶狀態
3. **資料庫**: SQLite 檔案權限需要適當設定
4. **Email**: SendGrid API 需要正確配置
5. **查詢限制**: 基本會員限制為永久 5 次，非每日重置

---

請在上述「修改點」區域添加您的具體修改說明，我將依序進行程式碼修改。
