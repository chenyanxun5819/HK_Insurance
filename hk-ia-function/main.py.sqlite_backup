from flask import Flask, request, jsonify, render_template, session, redirect, url_for
from takepdf import run_crawler, query_name, get_profiles_paginated, get_stats
from user_management import UserManager
from create_admin import create_admin_if_not_exists
from database_manager import DatabaseManager
import os
import json
import threading
import time

app = Flask(__name__)
app.secret_key = os.environ.get('SECRET_KEY', 'your-secret-key-change-in-production')

BUCKET_NAME = os.environ.get("BUCKET_NAME", "hk-ia-db")
DB_FILE = os.environ.get("DB_FILE", "aml_profiles.db")

# ğŸ”¥ æ–°å¢ï¼šè³‡æ–™åº«æŒä¹…åŒ–ç®¡ç†
print("ğŸš€ åˆå§‹åŒ–è³‡æ–™åº«ç®¡ç†å™¨...")
db_manager = DatabaseManager(BUCKET_NAME, DB_FILE)
db_manager.download_database()  # å•Ÿå‹•æ™‚ä¸‹è¼‰è³‡æ–™åº«

# åˆå§‹åŒ–ç”¨æˆ¶ç®¡ç†ï¼ˆä½¿ç”¨æŒä¹…åŒ–çš„è³‡æ–™åº«è·¯å¾‘ï¼‰
user_manager = UserManager(db_path=db_manager.get_db_path())

# ç¢ºä¿ç®¡ç†å“¡å¸³æˆ¶å­˜åœ¨
create_admin_if_not_exists(user_manager, db_manager)

# ğŸ”„ å•Ÿå‹•å®šæœŸå‚™ä»½åŸ·è¡Œç·’ï¼ˆæ¸›å°‘å³æ™‚å‚™ä»½å£“åŠ›ï¼‰
def periodic_backup():
    """å®šæœŸå‚™ä»½è³‡æ–™åº«"""
    while True:
        try:
            time.sleep(300)  # æ¯5åˆ†é˜å‚™ä»½ä¸€æ¬¡
            print("ğŸ• åŸ·è¡Œå®šæœŸè³‡æ–™åº«å‚™ä»½...")
            db_manager.upload_database(immediate=False)
        except Exception as e:
            print(f"âŒ å®šæœŸå‚™ä»½å¤±æ•—: {str(e)}")

backup_thread = threading.Thread(target=periodic_backup, daemon=True)
backup_thread.start()
print("âœ… å®šæœŸå‚™ä»½åŸ·è¡Œç·’å·²å•Ÿå‹•")

def require_auth():
    """æª¢æŸ¥ç”¨æˆ¶èªè­‰"""
    session_token = request.headers.get('Authorization') or request.cookies.get('session_token')
    if not session_token:
        print("DEBUG: No session token found")
        return {'valid': False, 'message': 'è«‹å…ˆç™»å…¥'}
    
    auth_result = user_manager.verify_session(session_token)
    if not auth_result.get('valid'):
        print(f"DEBUG: Session verification failed: {auth_result}")
    return auth_result

def require_admin():
    """æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™ - æœ€ç°¡åŒ–ç‰ˆæœ¬ï¼Œåªæª¢æŸ¥ email"""
    session_token = request.headers.get('Authorization') or request.cookies.get('session_token')
    print(f"DEBUG: Checking admin access with token: {session_token[:20] if session_token else 'None'}...")
    
    if not session_token:
        print("DEBUG: No session token found")
        return {'valid': False, 'message': 'è«‹å…ˆç™»å…¥'}
    
    try:
        # ä½¿ç”¨ç”¨æˆ¶ç®¡ç†å™¨é©—è­‰ session
        auth_result = user_manager.verify_session(session_token)
        print(f"DEBUG: Session verification result: {auth_result}")
        
        if auth_result.get('valid'):
            user = auth_result.get('user', {})
            user_email = user.get('email', '')
            print(f"DEBUG: User email from session: {user_email}")
            
            # åªè¦æ˜¯ astcws@hotmail.com å°±å…è¨±ç®¡ç†
            if user_email == 'astcws@hotmail.com':
                print(f"DEBUG: Admin access granted for: {user_email}")
                return auth_result
            else:
                print(f"DEBUG: Not admin email: {user_email}")
                return {'valid': False, 'message': 'éç®¡ç†å“¡å¸³æˆ¶'}
        else:
            print(f"DEBUG: Session invalid: {auth_result.get('message', 'Unknown error')}")
            return {'valid': False, 'message': 'è«‹é‡æ–°ç™»å…¥'}
            
    except Exception as e:
        print(f"DEBUG: Admin check error: {str(e)}")
        return {'valid': False, 'message': f'æª¢æŸ¥å¤±æ•—: {str(e)}'}

@app.route("/", methods=["GET"])
def home():
    """ä¸»é  - éœ€è¦ç™»å…¥æ‰èƒ½è¨ªå•"""
    auth_result = require_auth()
    if not auth_result.get('valid', False):
        return redirect('/login')
    
    return render_template("query.html")

@app.route("/register", methods=["GET", "POST"])
def register():
    """ç”¨æˆ¶è¨»å†Š"""
    if request.method == "GET":
        return render_template("register.html")
    
    try:
        data = request.get_json() if request.is_json else request.form
        email = data.get('email', '').strip()
        password = data.get('password', '').strip()
        
        if not email or not password:
            return jsonify({"success": False, "message": "è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"}), 400
        
        # ç°¡å–®çš„emailé©—è­‰
        if '@' not in email or '.' not in email:
            return jsonify({"success": False, "message": "è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€"}), 400
        
        result = user_manager.register_user(email, password)
        
        if result['success']:
            # âœ… ç«‹å³å‚™ä»½è³‡æ–™åº«ï¼ˆå°ˆå®¶å»ºè­°ï¼‰
            print("ğŸ”„ è¨»å†ŠæˆåŠŸï¼Œç«‹å³å‚™ä»½è³‡æ–™åº«...")
            try:
                db_manager.immediate_backup()
            except Exception as e:
                print(f"âš ï¸ è¨»å†Šå¾Œå‚™ä»½å¤±æ•—: {str(e)}")
            return jsonify(result), 201
        else:
            return jsonify(result), 400
            
    except Exception as e:
        return jsonify({"success": False, "message": f"è¨»å†Šå¤±æ•—: {str(e)}"}), 500

@app.route("/login", methods=["GET", "POST"])
def login():
    """ç”¨æˆ¶ç™»å…¥"""
    if request.method == "GET":
        return render_template("login.html")
    
    try:
        data = request.get_json() if request.is_json else request.form
        email = data.get('email', '').strip()
        password = data.get('password', '').strip()
        
        if not email or not password:
            return jsonify({"success": False, "message": "è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"}), 400
        
        result = user_manager.login_user(email, password)
        
        if result['success']:
            # è¨­ç½®cookie - æ”¹é€²å®‰å…¨æ€§è¨­å®š
            response = jsonify(result)
            # æª¢æŸ¥æ˜¯å¦ç‚ºé›²ç«¯ HTTPS ç’°å¢ƒ
            is_secure = request.is_secure or request.headers.get('X-Forwarded-Proto') == 'https'
            response.set_cookie('session_token', result['session_token'], 
                              max_age=7*24*60*60,  # å»¶é•·åˆ°7å¤©
                              httponly=True, 
                              secure=is_secure, 
                              samesite='Lax',
                              path='/')  # ç¢ºä¿æ‰€æœ‰è·¯å¾‘éƒ½å¯ä»¥è¨ªå•
            return response, 200
        else:
            return jsonify(result), 401
            
    except Exception as e:
        return jsonify({"success": False, "message": f"ç™»å…¥å¤±æ•—: {str(e)}"}), 500

@app.route("/logout", methods=["POST"])
def logout():
    """ç”¨æˆ¶ç™»å‡º"""
    try:
        session_token = request.headers.get('Authorization') or request.cookies.get('session_token')
        if session_token:
            user_manager.logout_user(session_token)
        
        response = jsonify({"success": True, "message": "ç™»å‡ºæˆåŠŸ"})
        response.set_cookie('session_token', '', expires=0)
        return response, 200
        
    except Exception as e:
        return jsonify({"success": False, "message": f"ç™»å‡ºå¤±æ•—: {str(e)}"}), 500

@app.route("/forgot-password", methods=["GET", "POST"])
def forgot_password():
    """å¿˜è¨˜å¯†ç¢¼"""
    if request.method == "GET":
        return render_template("forgot_password.html")
    
    try:
        data = request.get_json() if request.is_json else request.form
        email = data.get('email', '').strip()
        
        if not email:
            return jsonify({"success": False, "message": "è«‹è¼¸å…¥é›»å­éƒµä»¶"}), 400
        
        result = user_manager.forgot_password(email)
        
        if result['success']:
            # âœ… å¯†ç¢¼é‡è¨­æˆåŠŸå¾Œç«‹å³å‚™ä»½ï¼ˆå°ˆå®¶å»ºè­°ï¼‰
            print("ğŸ”„ å¯†ç¢¼é‡è¨­æˆåŠŸï¼Œç«‹å³å‚™ä»½è³‡æ–™åº«...")
            try:
                db_manager.immediate_backup()
            except Exception as e:
                print(f"âš ï¸ å¯†ç¢¼é‡è¨­å¾Œå‚™ä»½å¤±æ•—: {str(e)}")
            return jsonify(result), 200
        else:
            return jsonify(result), 400
            
    except Exception as e:
        return jsonify({"success": False, "message": f"é‡è¨­å¯†ç¢¼å¤±æ•—: {str(e)}"}), 500

@app.route("/profile", methods=["GET"])
def profile():
    """ç²å–ç”¨æˆ¶è³‡æ–™"""
    auth_result = require_auth()
    if not auth_result.get('valid', False):
        return jsonify(auth_result), 401
    
    user = auth_result['user']
    
    # ç²å–æŸ¥è©¢çµ±è¨ˆ
    query_stats = user_manager.check_query_limit(user['id'])
    
    return jsonify({
        "success": True,
        "user": user,
        "query_stats": query_stats
    }), 200

@app.route("/change-password", methods=["POST"])
def change_password():
    """æ›´æ”¹å¯†ç¢¼"""
    auth_result = require_auth()
    if not auth_result.get('valid', False):
        return jsonify(auth_result), 401
    
    user = auth_result['user']
    data = request.get_json()
    
    if not data:
        return jsonify({"success": False, "message": "ç¼ºå°‘è«‹æ±‚æ•¸æ“š"}), 400
    
    old_password = data.get('old_password')
    new_password = data.get('new_password')
    
    if not old_password or not new_password:
        return jsonify({"success": False, "message": "è«‹æä¾›èˆŠå¯†ç¢¼å’Œæ–°å¯†ç¢¼"}), 400
    
    # æ›´æ”¹å¯†ç¢¼
    result = user_manager.change_password(user['id'], old_password, new_password)
    
    if result['success']:
        # âœ… ç«‹å³å‚™ä»½è³‡æ–™åº«ï¼ˆå°ˆå®¶å»ºè­°ï¼‰
        print("ğŸ”„ å¯†ç¢¼æ›´æ”¹æˆåŠŸï¼Œç«‹å³å‚™ä»½è³‡æ–™åº«...")
        try:
            db_manager.immediate_backup()
        except Exception as e:
            print(f"âš ï¸ å¯†ç¢¼æ›´æ”¹å¾Œå‚™ä»½å¤±æ•—: {str(e)}")
        return jsonify(result), 200
    else:
        return jsonify(result), 400

@app.route("/update", methods=["GET", "POST"])
def update():
    """æ›´æ–°è³‡æ–™åº« - éœ€è¦èªè­‰"""
    # æª¢æŸ¥ç”¨æˆ¶èªè­‰
    auth_result = require_auth()
    if not auth_result.get('valid', False):
        return jsonify(auth_result), 401
    
    user = auth_result['user']
    
    # é€™è£¡å¯ä»¥æ·»åŠ ç®¡ç†å“¡æ¬Šé™æª¢æŸ¥
    # if user['email'] not in ['admin@example.com']:  # ç®¡ç†å“¡emailåˆ—è¡¨
    #     return jsonify({"success": False, "message": "åªæœ‰ç®¡ç†å“¡å¯ä»¥åŸ·è¡Œæ›´æ–°"}), 403
    
    try:
        print(f"ç”¨æˆ¶ {user['email']} è§¸ç™¼è³‡æ–™åº«æ›´æ–°")
        run_crawler(bucket_name=BUCKET_NAME, db_file=DB_FILE)
        return jsonify({"success": True, "message": "æ›´æ–°å®Œæˆ", "user": user['email']}), 200
    except Exception as e:
        return jsonify({"success": False, "message": f"æ›´æ–°å¤±æ•—: {str(e)}"}), 500

@app.route("/query", methods=["GET"])
def query():
    # æª¢æŸ¥ç”¨æˆ¶èªè­‰
    auth_result = require_auth()
    if not auth_result.get('valid', False):
        return jsonify(auth_result), 401
    
    user = auth_result['user']
    
    # æª¢æŸ¥æŸ¥è©¢é™åˆ¶
    query_limit_check = user_manager.check_query_limit(user['id'])
    if not query_limit_check['can_query']:
        return jsonify({
            "success": False, 
            "message": f"å·²é”åˆ°æ¯æ—¥æŸ¥è©¢é™åˆ¶ ({query_limit_check['daily_limit']} æ¬¡)",
            "query_stats": query_limit_check
        }), 429
    
    name = request.args.get("name")
    page = request.args.get("page", 1, type=int)
    per_page = request.args.get("per_page", 20, type=int)
    
    if not name:
        return jsonify({"error": "ç¼ºå°‘ name åƒæ•¸"}), 400
    
    try:
        # è¨˜éŒ„æŸ¥è©¢
        user_manager.log_query(user['id'], 'name_search', json.dumps({'name': name, 'page': page}))
        
        # âœ… æŸ¥è©¢è¨˜éŒ„å¾Œç«‹å³å‚™ä»½ï¼ˆå°ˆå®¶å»ºè­°ï¼‰
        try:
            db_manager.immediate_backup()
        except Exception as e:
            print(f"âš ï¸ æŸ¥è©¢è¨˜éŒ„å¾Œå‚™ä»½å¤±æ•—: {str(e)}")
        
        # å¦‚æœåœ¨æœ¬åœ°ç’°å¢ƒï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°æ•¸æ“šåº«é€²è¡Œåˆ†é æŸ¥è©¢
        if os.path.exists('aml_profiles.db'):
            import sqlite3
            
            conn = sqlite3.connect('aml_profiles.db')
            cursor = conn.cursor()
            
            # æª¢æŸ¥è¡¨å
            cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
            tables = [table[0] for table in cursor.fetchall()]
            table_name = 'aml_profiles' if 'aml_profiles' in tables else 'profiles'
            
            # æŸ¥è©¢åŒ…å«å§“åçš„è¨˜éŒ„ç¸½æ•¸ï¼ˆä¸åˆ†å¤§å°å¯«ï¼‰
            count_query = f"SELECT COUNT(*) FROM {table_name} WHERE LOWER(name) LIKE LOWER(?)"
            cursor.execute(count_query, [f"%{name}%"])
            total = cursor.fetchone()[0]
            
            if total == 0:
                conn.close()
                return jsonify({"found": False, "matches": [], "total": 0, "page": page, "per_page": per_page, "total_pages": 0}), 200
            
            # è¨ˆç®—åˆ†é 
            total_pages = (total + per_page - 1) // per_page
            offset = (page - 1) * per_page
            
            # æŸ¥è©¢åˆ†é æ•¸æ“šï¼ˆä¸åˆ†å¤§å°å¯«ï¼‰
            query_sql = f"""
            SELECT name, nationality, passport_no, year
            FROM {table_name} 
            WHERE LOWER(name) LIKE LOWER(?)
            ORDER BY year DESC, name
            LIMIT ? OFFSET ?
            """
            cursor.execute(query_sql, [f"%{name}%", per_page, offset])
            rows = cursor.fetchall()
            
            profiles = []
            for row in rows:
                name_val, nationality, passport_no, year = row
                profiles.append({
                    'name': name_val,
                    'nationality': nationality,
                    'passport_no': passport_no,
                    'year': year
                })
            
            conn.close()
            
            # æ›´æ–°æŸ¥è©¢çµ±è¨ˆ
            updated_stats = user_manager.check_query_limit(user['id'])
            
            return jsonify({
                "found": True,
                "profiles": profiles,
                "total": total,
                "page": page,
                "per_page": per_page,
                "total_pages": total_pages,
                "has_prev": page > 1,
                "has_next": page < total_pages,
                "query_stats": updated_stats
            }), 200
        else:
            # é›²ç«¯ç’°å¢ƒä½¿ç”¨åŸä¾†çš„æ–¹æ³•
            found, matches = query_name(bucket_name=BUCKET_NAME, db_file=DB_FILE, name=name)
            # å°‡åŸå§‹matchesè½‰æ›ç‚ºåˆ†é æ ¼å¼
            total = len(matches) if found else 0
            total_pages = (total + per_page - 1) // per_page if total > 0 else 0
            start_idx = (page - 1) * per_page
            end_idx = start_idx + per_page
            page_matches = matches[start_idx:end_idx] if found else []
            
            # æ›´æ–°æŸ¥è©¢çµ±è¨ˆ
            updated_stats = user_manager.check_query_limit(user['id'])
            
            return jsonify({
                "found": found,
                "matches": page_matches,
                "total": total,
                "page": page,
                "per_page": per_page,
                "total_pages": total_pages,
                "has_prev": page > 1,
                "has_next": page < total_pages,
                "query_stats": updated_stats
            }), 200
            
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route('/profiles')
def get_profiles():
    """ç²å–åˆ†é çš„åˆ¶è£åå–®"""
    # æª¢æŸ¥ç”¨æˆ¶èªè­‰
    auth_result = require_auth()
    if not auth_result.get('valid', False):
        return jsonify(auth_result), 401
    
    user = auth_result['user']
    
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    nationality = request.args.get('nationality', '')
    search_name = request.args.get('search_name', '')
    
    # å¦‚æœæœ‰æœå°‹æ¢ä»¶ï¼Œæª¢æŸ¥æŸ¥è©¢é™åˆ¶
    if search_name or nationality:
        query_limit_check = user_manager.check_query_limit(user['id'])
        if not query_limit_check['can_query']:
            return jsonify({
                "success": False, 
                "message": f"å·²é”åˆ°æ¯æ—¥æŸ¥è©¢é™åˆ¶ ({query_limit_check['daily_limit']} æ¬¡)",
                "query_stats": query_limit_check
            }), 429
        
        # è¨˜éŒ„æŸ¥è©¢
        user_manager.log_query(user['id'], 'profiles_search', 
                             json.dumps({'nationality': nationality, 'search_name': search_name, 'page': page}))
    
    # å¦‚æœåœ¨æœ¬åœ°ç’°å¢ƒï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°æ•¸æ“šåº«
    if os.path.exists('aml_profiles.db'):
        import sqlite3
        
        try:
            conn = sqlite3.connect('aml_profiles.db')
            cursor = conn.cursor()
            
            # æª¢æŸ¥è¡¨å
            cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
            tables = [table[0] for table in cursor.fetchall()]
            table_name = 'aml_profiles' if 'aml_profiles' in tables else 'profiles'
            
            # æ§‹å»ºæŸ¥è©¢æ¢ä»¶
            where_conditions = []
            params = []
            
            if nationality and nationality.strip():
                where_conditions.append("LOWER(nationality) LIKE LOWER(?)")
                params.append(f"%{nationality.strip()}%")
                
            if search_name and search_name.strip():
                where_conditions.append("LOWER(name) LIKE LOWER(?)")
                params.append(f"%{search_name.strip()}%")
            
            where_clause = " WHERE " + " AND ".join(where_conditions) if where_conditions else ""
            
            # æŸ¥è©¢ç¸½æ•¸
            count_query = f"SELECT COUNT(*) FROM {table_name}{where_clause}"
            cursor.execute(count_query, params)
            total = cursor.fetchone()[0]
            
            # è¨ˆç®—åˆ†é 
            total_pages = (total + per_page - 1) // per_page
            offset = (page - 1) * per_page
            
            # æŸ¥è©¢æ•¸æ“š
            query = f"""
            SELECT name, nationality, passport_no, year
            FROM {table_name}{where_clause}
            ORDER BY year DESC, name
            LIMIT ? OFFSET ?
            """
            cursor.execute(query, params + [per_page, offset])
            rows = cursor.fetchall()
            
            profiles = []
            for row in rows:
                name, nationality, passport_no, year = row
                profiles.append({
                    'name': name,
                    'nationality': nationality,
                    'passport_no': passport_no,
                    'year': year,
                    'source_pdf': '',
                    'source_url': ''
                })
            
            conn.close()
            
            # ç²å–æ›´æ–°çš„æŸ¥è©¢çµ±è¨ˆ
            updated_stats = user_manager.check_query_limit(user['id'])
            
            result = {
                'profiles': profiles,
                'total': total,
                'page': page,
                'per_page': per_page,
                'total_pages': total_pages,
                'has_prev': page > 1,
                'has_next': page < total_pages,
                'query_stats': updated_stats
            }
        except Exception as e:
            print(f"æœ¬åœ°æ•¸æ“šåº«æŸ¥è©¢éŒ¯èª¤: {e}")
            result = {
                'profiles': [],
                'total': 0,
                'page': 1,
                'per_page': per_page,
                'total_pages': 0,
                'has_prev': False,
                'has_next': False
            }
    else:
        # é›²ç«¯ç’°å¢ƒä½¿ç”¨åŸä¾†çš„æ–¹æ³•
        result = get_profiles_paginated('hk-ia-db', 'aml_profiles.db', page, per_page, 
                                      nationality if nationality else None,
                                      search_name if search_name else None)
        
        # ç²å–æ›´æ–°çš„æŸ¥è©¢çµ±è¨ˆ
        updated_stats = user_manager.check_query_limit(user['id'])
        result['query_stats'] = updated_stats
    
    return jsonify(result)
    """åˆ†é ç€è¦½åˆ¶è£åå–®"""
    try:
        page = int(request.args.get("page", 1))
        nationality = request.args.get("nationality", "").strip()
        per_page = 20
        
        data = get_profiles_paginated(
            bucket_name=BUCKET_NAME, 
            db_file=DB_FILE, 
            page=page, 
            per_page=per_page,
            nationality=nationality
        )
        return jsonify(data), 200
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route("/stats", methods=["GET"])
def stats():
    """ç²å–çµ±è¨ˆè³‡è¨Š"""
    try:
        # å¦‚æœåœ¨æœ¬åœ°ç’°å¢ƒï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°æ•¸æ“šåº«
        if os.path.exists('aml_profiles.db'):
            import sqlite3
            
            conn = sqlite3.connect('aml_profiles.db')
            cursor = conn.cursor()
            
            # æª¢æŸ¥è¡¨å
            cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
            tables = [table[0] for table in cursor.fetchall()]
            table_name = 'aml_profiles' if 'aml_profiles' in tables else 'profiles'
            
            # ç¸½æ•¸çµ±è¨ˆ
            cursor.execute(f"SELECT COUNT(*) FROM {table_name}")
            total_profiles = cursor.fetchone()[0]
            
            # å¹´ä»½çµ±è¨ˆ
            cursor.execute(f"SELECT year, COUNT(*) as count FROM {table_name} GROUP BY year ORDER BY year DESC")
            year_stats = cursor.fetchall()
            
            # åœ‹ç±çµ±è¨ˆ
            cursor.execute(f"SELECT nationality, COUNT(*) as count FROM {table_name} GROUP BY nationality ORDER BY count DESC LIMIT 10")
            nationality_stats = cursor.fetchall()
            
            # æœ€æ–°æ•¸æ“šå¹´ä»½
            cursor.execute(f"SELECT MAX(year) FROM {table_name}")
            latest_year = cursor.fetchone()[0]
            
            conn.close()
            
            data = {
                'total_profiles': total_profiles,
                'latest_year': latest_year,
                'year_stats': year_stats,
                'nationality_stats': nationality_stats
            }
        else:
            # é›²ç«¯ç’°å¢ƒä½¿ç”¨åŸä¾†çš„æ–¹æ³•
            data = get_stats(bucket_name=BUCKET_NAME, db_file=DB_FILE)
        
        return jsonify(data), 200
    except Exception as e:
        return jsonify({"error": str(e)}), 500

# ========== ç®¡ç†å“¡åŠŸèƒ½ ==========

@app.route("/force-admin-login", methods=["GET"])
def force_admin_login():
    """å¼·åˆ¶ç®¡ç†å“¡ç™»å…¥ - åƒ…ç”¨æ–¼èª¿è©¦"""
    try:
        # ç›´æ¥ç™»å…¥ç®¡ç†å“¡å¸³æˆ¶
        result = user_manager.login_user("astcws@hotmail.com", "admin123")
        
        if result['success']:
            response = jsonify({
                "success": True,
                "message": "ç®¡ç†å“¡å¼·åˆ¶ç™»å…¥æˆåŠŸ",
                "redirect": "/admin"
            })
            
            # è¨­ç½® cookie
            is_secure = request.is_secure or request.headers.get('X-Forwarded-Proto') == 'https'
            response.set_cookie('session_token', result['session_token'], 
                              max_age=7*24*60*60,
                              httponly=True, 
                              secure=is_secure, 
                              samesite='Lax',
                              path='/')
            return response
        else:
            return jsonify({"success": False, "message": f"ç™»å…¥å¤±æ•—: {result['message']}"})
            
    except Exception as e:
        return jsonify({"success": False, "message": f"éŒ¯èª¤: {str(e)}"})

@app.route("/debug-auth", methods=["GET"])
def debug_auth():
    """èª¿è©¦èªè­‰ç‹€æ…‹"""
    session_token = request.cookies.get('session_token')
    
    debug_info = {
        'has_session_token': bool(session_token),
        'session_token_preview': session_token[:20] if session_token else None,
        'cookies': dict(request.cookies),
        'headers': dict(request.headers)
    }
    
    if session_token:
        admin_check = require_admin()
        debug_info['admin_check'] = admin_check
    
    return jsonify(debug_info)

@app.route("/admin", methods=["GET"])
def admin_panel():
    """ç®¡ç†å“¡é¢æ¿"""
    print("=== DEBUG: Admin panel accessed ===")
    
    # æª¢æŸ¥ cookies
    session_token = request.cookies.get('session_token')
    print(f"DEBUG: Session token from cookie: {session_token[:20] if session_token else 'None'}...")
    
    # å…ˆæª¢æŸ¥ç”¨æˆ¶èªè­‰
    auth_result = require_auth()
    print(f"DEBUG: Auth result: {auth_result}")
    
    if not auth_result.get('valid'):
        print(f"DEBUG: Auth failed, redirecting to login")
        return redirect("/login")
    
    # æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡ email
    user = auth_result.get('user', {})
    user_email = user.get('email', '')
    print(f"DEBUG: User email: {user_email}")
    
    if user_email != 'astcws@hotmail.com':
        print(f"DEBUG: Not admin email, redirecting to login")
        return redirect("/login")
    
    print(f"DEBUG: Admin access granted, rendering admin.html")
    return render_template("admin.html")

@app.route("/admin/users", methods=["GET"])
def admin_get_users():
    """ç²å–æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨ï¼ˆç®¡ç†å“¡åŠŸèƒ½ï¼‰"""
    admin_check = require_admin()
    if not admin_check.get('valid'):
        return jsonify(admin_check), 403
    
    result = user_manager.get_all_users()
    if result['success']:
        return jsonify(result), 200
    else:
        return jsonify(result), 500

@app.route("/admin/users/<int:user_id>/membership", methods=["PUT"])
def admin_update_membership(user_id):
    """æ›´æ–°ç”¨æˆ¶æœƒå“¡ç­‰ç´šï¼ˆç®¡ç†å“¡åŠŸèƒ½ï¼‰"""
    admin_check = require_admin()
    if not admin_check.get('valid'):
        return jsonify(admin_check), 403
    
    try:
        data = request.get_json()
        new_level = data.get('membership_level')
        
        if new_level not in ['basic', 'premium', 'super']:
            return jsonify({"success": False, "message": "ç„¡æ•ˆçš„æœƒå“¡ç­‰ç´š"}), 400
        
        result = user_manager.update_user_membership(user_id, new_level)
        if result['success']:
            # âœ… ç®¡ç†å“¡æ›´æ–°æœƒå“¡ç­‰ç´šå¾Œç«‹å³å‚™ä»½ï¼ˆå°ˆå®¶å»ºè­°ï¼‰
            print("ğŸ”„ æœƒå“¡ç­‰ç´šæ›´æ–°æˆåŠŸï¼Œç«‹å³å‚™ä»½è³‡æ–™åº«...")
            try:
                db_manager.immediate_backup()
            except Exception as e:
                print(f"âš ï¸ æœƒå“¡ç­‰ç´šæ›´æ–°å¾Œå‚™ä»½å¤±æ•—: {str(e)}")
            return jsonify(result), 200
        else:
            return jsonify(result), 400
    except Exception as e:
        return jsonify({"success": False, "message": str(e)}), 500

@app.route("/admin/users/<int:user_id>/status", methods=["PUT"])
def admin_update_user_status(user_id):
    """å•Ÿç”¨/åœç”¨ç”¨æˆ¶ï¼ˆç®¡ç†å“¡åŠŸèƒ½ï¼‰"""
    admin_check = require_admin()
    if not admin_check.get('valid'):
        return jsonify(admin_check), 403
    
    try:
        data = request.get_json()
        action = data.get('action')  # 'activate' or 'deactivate'
        
        if action == 'activate':
            result = user_manager.activate_user(user_id)
        elif action == 'deactivate':
            result = user_manager.deactivate_user(user_id)
        else:
            return jsonify({"success": False, "message": "ç„¡æ•ˆçš„æ“ä½œ"}), 400
        
        if result['success']:
            # âœ… ç®¡ç†å“¡ç”¨æˆ¶ç‹€æ…‹æ›´æ–°å¾Œç«‹å³å‚™ä»½ï¼ˆå°ˆå®¶å»ºè­°ï¼‰
            print("ğŸ”„ ç”¨æˆ¶ç‹€æ…‹æ›´æ–°æˆåŠŸï¼Œç«‹å³å‚™ä»½è³‡æ–™åº«...")
            try:
                db_manager.immediate_backup()
            except Exception as e:
                print(f"âš ï¸ ç”¨æˆ¶ç‹€æ…‹æ›´æ–°å¾Œå‚™ä»½å¤±æ•—: {str(e)}")
            return jsonify(result), 200
        else:
            return jsonify(result), 400
    except Exception as e:
        return jsonify({"success": False, "message": str(e)}), 500

@app.route("/admin/users/<int:user_id>/password", methods=["PUT"])
def admin_reset_password(user_id):
    """é‡ç½®ç”¨æˆ¶å¯†ç¢¼ï¼ˆç®¡ç†å“¡åŠŸèƒ½ï¼‰"""
    admin_check = require_admin()
    if not admin_check.get('valid'):
        return jsonify(admin_check), 403
    
    try:
        data = request.get_json()
        new_password = data.get('new_password')
        
        if not new_password or len(new_password) < 6:
            return jsonify({"success": False, "message": "å¯†ç¢¼é•·åº¦è‡³å°‘6ä½"}), 400
        
        result = user_manager.reset_user_password(user_id, new_password)
        if result['success']:
            # âœ… ç®¡ç†å“¡é‡ç½®å¯†ç¢¼å¾Œç«‹å³å‚™ä»½ï¼ˆå°ˆå®¶å»ºè­°ï¼‰
            print("ğŸ”„ ç®¡ç†å“¡é‡ç½®å¯†ç¢¼æˆåŠŸï¼Œç«‹å³å‚™ä»½è³‡æ–™åº«...")
            try:
                db_manager.immediate_backup()
            except Exception as e:
                print(f"âš ï¸ ç®¡ç†å“¡é‡ç½®å¯†ç¢¼å¾Œå‚™ä»½å¤±æ•—: {str(e)}")
            return jsonify(result), 200
        else:
            return jsonify(result), 400
    except Exception as e:
        return jsonify({"success": False, "message": str(e)}), 500

@app.route("/admin/users/<int:user_id>/stats", methods=["GET"])
def admin_get_user_stats(user_id):
    """ç²å–ç”¨æˆ¶æŸ¥è©¢çµ±è¨ˆï¼ˆç®¡ç†å“¡åŠŸèƒ½ï¼‰"""
    admin_check = require_admin()
    if not admin_check.get('valid'):
        return jsonify(admin_check), 403
    
    result = user_manager.get_user_query_stats(user_id)
    if result['success']:
        return jsonify(result), 200
    else:
        return jsonify(result), 500

if __name__ == "__main__":
    # è¨­ç½®è³‡æ–™åº«å®šæœŸå‚™ä»½
    import threading
    import time
    
    def periodic_backup():
        """å®šæœŸå‚™ä»½è³‡æ–™åº«"""
        while True:
            time.sleep(300)  # æ¯5åˆ†é˜å‚™ä»½ä¸€æ¬¡
            try:
                db_manager.upload_database()
                print("ğŸ”„ å®šæœŸå‚™ä»½å®Œæˆ")
            except Exception as e:
                print(f"âŒ å®šæœŸå‚™ä»½å¤±æ•—: {str(e)}")
    
    # å•Ÿå‹•èƒŒæ™¯å‚™ä»½åŸ·è¡Œç·’
    backup_thread = threading.Thread(target=periodic_backup, daemon=True)
    backup_thread.start()
    
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))
