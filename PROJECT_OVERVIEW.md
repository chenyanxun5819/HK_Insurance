# HK Insurance AML 查詢平台 - 專案概覽

## 📋 專案目標
**香港保險業反洗錢 (AML) 制裁名單查詢平台**
- 提供香港保險業從業人員查詢國際制裁名單的工具
- 協助保險公司進行客戶背景調查和合規檢查
- 確保符合香港金融管理局 (HKMA) 的反洗錢法規要求

## 🗃️ 核心資料
### AML 制裁名單資料庫
- **資料量**: 14,528+ 筆記錄
- **時間範圍**: 2015-2024 年 (主要資料)
- **原始檔案**: 2001-2025 年 PDF 文件 (downloads/ 資料夾)
- **資料來源**: 香港保險業監管局官方發布的制裁名單
- **資料結構**:
  ```sql
  CREATE TABLE profiles (
    id INTEGER PRIMARY KEY,
    year INTEGER,
    name TEXT,
    nationality TEXT,
    passport_no TEXT,
    source_pdf TEXT,
    source_url TEXT,
    created_at TEXT
  );
  ```

## 🏗️ 系統架構

### 原始架構 (SQLite + Flask)
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   用戶管理      │    │   AML 查詢引擎   │    │   PDF 爬蟲      │
│  (SQLite)       │◄──►│   (SQLite)       │◄──►│  (downloads/)   │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         ▲                        ▲
         │                        │
         ▼                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Flask Web 應用程式                          │
│                   (main.py + templates/)                       │
└─────────────────────────────────────────────────────────────────┘
```

### 目標架構 (Firestore + Flask)
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   用戶管理      │    │   AML 資料庫     │    │   PDF 爬蟲      │
│  (Firestore)    │◄──►│  (Firestore)     │◄──►│  (downloads/)   │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         ▲                        ▲
         │                        │
         ▼                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Flask Web 應用程式                          │
│                   (main.py + templates/)                       │
└─────────────────────────────────────────────────────────────────┘
```

## 👥 用戶管理系統

### 用戶等級與權限
- **管理員** (`astcws@gmail.com`)
  - 無限制查詢
  - 用戶管理權限
  - 系統設定權限

- **基本用戶** (`basic`)
  - 每日查詢限制: 50 次
  - 基本查詢功能

- **高級用戶** (`premium`)
  - 每日查詢限制: 200 次
  - 進階查詢功能

### 認證機制
- Session Token 認證 (hex 編碼)
- Cookie + Authorization Header 雙重支援
- 自動過期管理 (7天)

## 🔍 查詢功能

### 核心查詢功能
1. **姓名模糊查詢**: 支援部分姓名匹配
2. **國籍篩選**: 按國籍過濾結果
3. **分頁顯示**: 每頁 20-50 筆記錄
4. **查詢統計**: 記錄用戶查詢歷史

### API 端點
- `GET /query?name=<姓名>&page=<頁數>` - 姓名查詢
- `GET /profiles?nationality=<國籍>` - 分頁瀏覽
- `GET /admin/users` - 用戶管理 (管理員)

## 📁 檔案結構
```
HK_insurance/
├── main.py                    # Flask 主應用程式
├── takepdf.py                 # PDF 爬蟲和查詢引擎
├── user_management_firestore.py  # Firestore 用戶管理
├── create_admin.py            # 管理員帳戶創建
├── aml_profiles.db            # SQLite 資料庫 (14,528 筆)
├── downloads/                 # PDF 檔案 (2001-2025)
│   ├── 2001/...
│   ├── 2002/...
│   └── 2025/...
├── hk-ia-function/           # Cloud Run 部署版本
└── templates/                # HTML 模板
    ├── login.html
    ├── query.html
    └── admin.html
```

## 🚀 部署環境

### Google Cloud Platform
- **專案**: `hk-insurance-crawler`
- **Cloud Run**: https://hk-insurance-aml-574812669587.asia-east1.run.app
- **Firestore**: asia-east1 區域
- **Cloud Storage**: 多個備份 bucket

### 本地開發環境
- **Flask 開發伺服器**: `127.0.0.1:8000`
- **Firebase Emulator**: `127.0.0.1:8081` (Firestore), `127.0.0.1:4000` (UI)
- **Python 虛擬環境**: `venv/`

## 🔄 遷移歷程

### 已完成的遷移
1. ✅ **用戶管理系統** SQLite → Firestore
2. ✅ **Firebase Emulator 設置**
3. ✅ **虛擬環境建立**
4. ✅ **管理員帳戶遷移**

### 待完成的遷移
1. ❌ **AML 資料庫遷移** (14,528 筆) SQLite → Firestore
2. ❌ **查詢引擎更新** 連接 Firestore
3. ❌ **生產環境部署**

## ⚠️ 重要提醒

### 資料完整性
- **主要資料**: 14,528 筆 AML 制裁名單記錄
- **必須確保**: 資料遷移時不能遺失任何記錄
- **驗證方法**: 遷移前後記錄數量比對

### 系統可用性
- **零停機時間**: 遷移過程中系統必須保持可用
- **備份策略**: 遷移前必須備份所有資料
- **回滾計劃**: 遷移失敗時的恢復方案

### 法規合規
- **資料安全**: 制裁名單資料屬敏感資訊
- **存取控制**: 嚴格的用戶權限管理
- **審計追蹤**: 所有查詢操作的完整記錄

## 📅 下次開發重點
1. **完成 AML 資料庫遷移** - 最高優先級
2. **更新查詢引擎** - 連接 Firestore
3. **生產環境測試** - 確保功能完整
4. **效能最佳化** - 大量資料查詢優化

---
*最後更新: 2025年9月5日*
*狀態: 部分遷移完成，等待 AML 資料庫遷移*
